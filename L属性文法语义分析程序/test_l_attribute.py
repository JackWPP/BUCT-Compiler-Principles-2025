#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Lå±æ€§æ–‡æ³•è¯­ä¹‰åˆ†æç¨‹åºç®€å•æµ‹è¯•è„šæœ¬

ä½œè€…: ç‹æµ·ç¿”
å­¦å·: 2021060187
ç­çº§: è®¡ç§‘2203
"""

import sys
import os

# æ·»åŠ å½“å‰ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

# å¯¼å…¥ä¸»ç¨‹åºæ¨¡å—
from l_attribute_main import (
    Lå±æ€§æ–‡æ³•, Lå±æ€§æ–‡æ³•è§£æå™¨, è¯­ä¹‰åˆ†æå¼•æ“,
    å±æ€§å®šä¹‰, æ–‡æ³•ç¬¦å·, äº§ç”Ÿå¼, è¯­ä¹‰è§„åˆ™, ç¬¦å·è¡¨é¡¹, ç¬¦å·è¡¨,
    å±æ€§ç±»å‹, ç¬¦å·ç±»å‹
)


def test_basic_functionality():
    """æµ‹è¯•åŸºæœ¬åŠŸèƒ½"""
    print("=== æµ‹è¯•åŸºæœ¬åŠŸèƒ½ ===")
    
    try:
        # 1. æµ‹è¯•æ–‡æ³•ç¬¦å·åˆ›å»º
        print("1. æµ‹è¯•æ–‡æ³•ç¬¦å·åˆ›å»º...")
        ç»ˆç»“ç¬¦ = æ–‡æ³•ç¬¦å·("id", ç¬¦å·ç±»å‹.ç»ˆç»“ç¬¦)
        éç»ˆç»“ç¬¦ = æ–‡æ³•ç¬¦å·("E", ç¬¦å·ç±»å‹.éç»ˆç»“ç¬¦)
        print("   âœ“ æ–‡æ³•ç¬¦å·åˆ›å»ºæˆåŠŸ")
        
        # 2. æµ‹è¯•å±æ€§å®šä¹‰åˆ›å»º
        print("2. æµ‹è¯•å±æ€§å®šä¹‰åˆ›å»º...")
        ç»¼åˆå±æ€§ = å±æ€§å®šä¹‰("value", å±æ€§ç±»å‹.ç»¼åˆå±æ€§, "æ•´æ•°", 0, "å€¼å±æ€§")
        ç»§æ‰¿å±æ€§ = å±æ€§å®šä¹‰("type", å±æ€§ç±»å‹.ç»§æ‰¿å±æ€§, "å­—ç¬¦ä¸²", "", "ç±»å‹å±æ€§")
        print("   âœ“ å±æ€§å®šä¹‰åˆ›å»ºæˆåŠŸ")
        
        # 3. æµ‹è¯•äº§ç”Ÿå¼åˆ›å»º
        print("3. æµ‹è¯•äº§ç”Ÿå¼åˆ›å»º...")
        äº§ç”Ÿå¼å¯¹è±¡ = äº§ç”Ÿå¼("E", ["E", "+", "T"])
        print(f"   äº§ç”Ÿå¼: {äº§ç”Ÿå¼å¯¹è±¡}")
        print("   âœ“ äº§ç”Ÿå¼åˆ›å»ºæˆåŠŸ")
        
        # 4. æµ‹è¯•è¯­ä¹‰è§„åˆ™åˆ›å»º
        print("4. æµ‹è¯•è¯­ä¹‰è§„åˆ™åˆ›å»º...")
        è§„åˆ™ = è¯­ä¹‰è§„åˆ™("E.value", "E1.value + T.value", ["E1.value", "T.value"])
        print(f"   è¯­ä¹‰è§„åˆ™: {è§„åˆ™}")
        print("   âœ“ è¯­ä¹‰è§„åˆ™åˆ›å»ºæˆåŠŸ")
        
        return True
        
    except Exception as e:
        print(f"   âœ— åŸºæœ¬åŠŸèƒ½æµ‹è¯•å¤±è´¥: {e}")
        return False


def test_grammar_parsing():
    """æµ‹è¯•æ–‡æ³•è§£æ"""
    print("\n=== æµ‹è¯•æ–‡æ³•è§£æ ===")
    
    try:
        è§£æå™¨ = Lå±æ€§æ–‡æ³•è§£æå™¨()
        
        æ–‡æ³•å†…å®¹ = """
[æ–‡æ³•]
D -> T L
T -> int
L -> id

[å±æ€§å®šä¹‰]
T.type : ç»¼åˆ å­—ç¬¦ä¸² "" "ç±»å‹ä¿¡æ¯"
L.in : ç»§æ‰¿ å­—ç¬¦ä¸² "" "ç»§æ‰¿ç±»å‹"

[è¯­ä¹‰è§„åˆ™]
L.in := T.type
"""
        
        print("1. è§£æç®€å•Lå±æ€§æ–‡æ³•...")
        æˆåŠŸ, æ–‡æ³•, é”™è¯¯åˆ—è¡¨ = è§£æå™¨.è§£ææ–‡æ³•æ–‡ä»¶(æ–‡æ³•å†…å®¹)
        
        if æˆåŠŸ:
            print("   âœ“ æ–‡æ³•è§£ææˆåŠŸ")
            print(f"   äº§ç”Ÿå¼æ•°é‡: {len(æ–‡æ³•.äº§ç”Ÿå¼åˆ—è¡¨)}")
            print(f"   å¼€å§‹ç¬¦å·: {æ–‡æ³•.å¼€å§‹ç¬¦å·}")
            print(f"   ç»ˆç»“ç¬¦: {sorted(æ–‡æ³•.ç»ˆç»“ç¬¦é›†åˆ)}")
            print(f"   éç»ˆç»“ç¬¦: {sorted(æ–‡æ³•.éç»ˆç»“ç¬¦é›†åˆ)}")
            
            # éªŒè¯Lå±æ€§ç‰¹æ€§
            print("2. éªŒè¯Lå±æ€§ç‰¹æ€§...")
            æ˜¯Lå±æ€§, Lå±æ€§é”™è¯¯ = æ–‡æ³•.éªŒè¯Lå±æ€§ç‰¹æ€§()
            if æ˜¯Lå±æ€§:
                print("   âœ“ Lå±æ€§ç‰¹æ€§éªŒè¯é€šè¿‡")
            else:
                print(f"   âœ— Lå±æ€§ç‰¹æ€§éªŒè¯å¤±è´¥: {Lå±æ€§é”™è¯¯}")
            
            return True
        else:
            print(f"   âœ— æ–‡æ³•è§£æå¤±è´¥: {é”™è¯¯åˆ—è¡¨}")
            return False
            
    except Exception as e:
        print(f"   âœ— æ–‡æ³•è§£ææµ‹è¯•å¤±è´¥: {e}")
        return False


def test_symbol_table():
    """æµ‹è¯•ç¬¦å·è¡¨ç®¡ç†"""
    print("\n=== æµ‹è¯•ç¬¦å·è¡¨ç®¡ç† ===")
    
    try:
        ç¬¦å·è¡¨å¯¹è±¡ = ç¬¦å·è¡¨()
        
        print("1. æµ‹è¯•ç¬¦å·è¡¨åŸºæœ¬æ“ä½œ...")
        # æ·»åŠ ç¬¦å·
        ç¬¦å·é¡¹ = ç¬¦å·è¡¨é¡¹("variable1", "int", 42)
        ç¬¦å·è¡¨å¯¹è±¡.æ·»åŠ ç¬¦å·(ç¬¦å·é¡¹)
        
        # æŸ¥æ‰¾ç¬¦å·
        æ‰¾åˆ°çš„ç¬¦å· = ç¬¦å·è¡¨å¯¹è±¡.æŸ¥æ‰¾ç¬¦å·("variable1")
        if æ‰¾åˆ°çš„ç¬¦å·:
            print(f"   æ‰¾åˆ°ç¬¦å·: {æ‰¾åˆ°çš„ç¬¦å·.åç§°} ({æ‰¾åˆ°çš„ç¬¦å·.ç±»å‹}) = {æ‰¾åˆ°çš„ç¬¦å·.å€¼}")
            print("   âœ“ ç¬¦å·è¡¨åŸºæœ¬æ“ä½œæˆåŠŸ")
        else:
            print("   âœ— ç¬¦å·æŸ¥æ‰¾å¤±è´¥")
            return False
        
        print("2. æµ‹è¯•ä½œç”¨åŸŸç®¡ç†...")
        # è¿›å…¥æ–°ä½œç”¨åŸŸ
        ç¬¦å·è¡¨å¯¹è±¡.è¿›å…¥ä½œç”¨åŸŸ("å‡½æ•°1")
        å±€éƒ¨ç¬¦å· = ç¬¦å·è¡¨é¡¹("local_var", "float")
        ç¬¦å·è¡¨å¯¹è±¡.æ·»åŠ ç¬¦å·(å±€éƒ¨ç¬¦å·)
        
        # æŸ¥æ‰¾ç¬¦å·
        å…¨å±€ç¬¦å· = ç¬¦å·è¡¨å¯¹è±¡.æŸ¥æ‰¾ç¬¦å·("variable1")
        å±€éƒ¨ç¬¦å·æŸ¥æ‰¾ = ç¬¦å·è¡¨å¯¹è±¡.æŸ¥æ‰¾ç¬¦å·("local_var")
        
        if å…¨å±€ç¬¦å· and å±€éƒ¨ç¬¦å·æŸ¥æ‰¾:
            print("   âœ“ ä½œç”¨åŸŸç®¡ç†æˆåŠŸ")
        else:
            print("   âœ— ä½œç”¨åŸŸç®¡ç†å¤±è´¥")
            return False
        
        # é€€å‡ºä½œç”¨åŸŸ
        ç¬¦å·è¡¨å¯¹è±¡.é€€å‡ºä½œç”¨åŸŸ()
        print("   âœ“ ä½œç”¨åŸŸé€€å‡ºæˆåŠŸ")
        
        return True
        
    except Exception as e:
        print(f"   âœ— ç¬¦å·è¡¨æµ‹è¯•å¤±è´¥: {e}")
        return False


def test_semantic_analysis():
    """æµ‹è¯•è¯­ä¹‰åˆ†æ"""
    print("\n=== æµ‹è¯•è¯­ä¹‰åˆ†æ ===")
    
    try:
        # åˆ›å»ºæµ‹è¯•æ–‡æ³•
        æ–‡æ³• = Lå±æ€§æ–‡æ³•()
        
        # æ·»åŠ äº§ç”Ÿå¼
        äº§ç”Ÿå¼1 = äº§ç”Ÿå¼("D", ["T", "L"])
        äº§ç”Ÿå¼2 = äº§ç”Ÿå¼("T", ["int"])
        äº§ç”Ÿå¼3 = äº§ç”Ÿå¼("L", ["id"])
        
        æ–‡æ³•.æ·»åŠ äº§ç”Ÿå¼(äº§ç”Ÿå¼1)
        æ–‡æ³•.æ·»åŠ äº§ç”Ÿå¼(äº§ç”Ÿå¼2)
        æ–‡æ³•.æ·»åŠ äº§ç”Ÿå¼(äº§ç”Ÿå¼3)
        
        print("1. åˆ›å»ºè¯­ä¹‰åˆ†æå¼•æ“...")
        åˆ†æå¼•æ“ = è¯­ä¹‰åˆ†æå¼•æ“(æ–‡æ³•)
        print("   âœ“ è¯­ä¹‰åˆ†æå¼•æ“åˆ›å»ºæˆåŠŸ")
        
        print("2. æµ‹è¯•è¯æ³•åˆ†æ...")
        è¾“å…¥ä¸² = "int variable1"
        è¯æ³•å•å…ƒåˆ—è¡¨ = åˆ†æå¼•æ“._è¯æ³•åˆ†æ(è¾“å…¥ä¸²)
        print(f"   è¯æ³•å•å…ƒ: {è¯æ³•å•å…ƒåˆ—è¡¨}")
        
        if len(è¯æ³•å•å…ƒåˆ—è¡¨) == 2:
            print("   âœ“ è¯æ³•åˆ†ææˆåŠŸ")
        else:
            print("   âœ— è¯æ³•åˆ†æå¤±è´¥")
            return False
        
        print("3. æµ‹è¯•è¯­ä¹‰åˆ†ææ‰§è¡Œ...")
        è¯­æ³•åˆ†æç»“æœ = [0, 1, 2]  # æ¨¡æ‹Ÿçš„äº§ç”Ÿå¼åºåˆ—
        æˆåŠŸ, åˆ†ææ­¥éª¤åˆ—è¡¨, é”™è¯¯ä¿¡æ¯ = åˆ†æå¼•æ“.æ‰§è¡Œè¯­ä¹‰åˆ†æ(è¾“å…¥ä¸², è¯­æ³•åˆ†æç»“æœ)
        
        if æˆåŠŸ or len(åˆ†ææ­¥éª¤åˆ—è¡¨) > 0:
            print(f"   åˆ†ææ­¥éª¤æ•°: {len(åˆ†ææ­¥éª¤åˆ—è¡¨)}")
            print("   âœ“ è¯­ä¹‰åˆ†ææ‰§è¡ŒæˆåŠŸ")
        else:
            print(f"   âœ— è¯­ä¹‰åˆ†ææ‰§è¡Œå¤±è´¥: {é”™è¯¯ä¿¡æ¯}")
            return False
        
        return True
        
    except Exception as e:
        print(f"   âœ— è¯­ä¹‰åˆ†ææµ‹è¯•å¤±è´¥: {e}")
        return False


def test_integration():
    """æµ‹è¯•é›†æˆåŠŸèƒ½"""
    print("\n=== æµ‹è¯•é›†æˆåŠŸèƒ½ ===")
    
    try:
        # å®Œæ•´çš„æ–‡æ³•å®šä¹‰
        æ–‡æ³•å†…å®¹ = """
[æ–‡æ³•]
D -> T L
T -> int | float
L -> L , id | id

[å±æ€§å®šä¹‰]
T.type : ç»¼åˆ å­—ç¬¦ä¸² "" "ç±»å‹ä¿¡æ¯"
L.in : ç»§æ‰¿ å­—ç¬¦ä¸² "" "ç»§æ‰¿ç±»å‹"
id.name : ç»¼åˆ å­—ç¬¦ä¸² "" "æ ‡è¯†ç¬¦åç§°"

[è¯­ä¹‰è§„åˆ™]
L.in := T.type
T.type := "int"
"""
        
        print("1. è§£æå®Œæ•´æ–‡æ³•...")
        è§£æå™¨ = Lå±æ€§æ–‡æ³•è§£æå™¨()
        æˆåŠŸ, æ–‡æ³•, é”™è¯¯åˆ—è¡¨ = è§£æå™¨.è§£ææ–‡æ³•æ–‡ä»¶(æ–‡æ³•å†…å®¹)
        
        if not æˆåŠŸ:
            print(f"   âœ— æ–‡æ³•è§£æå¤±è´¥: {é”™è¯¯åˆ—è¡¨}")
            return False
        
        print("   âœ“ æ–‡æ³•è§£ææˆåŠŸ")
        
        print("2. æ‰§è¡Œè¯­ä¹‰åˆ†æ...")
        åˆ†æå¼•æ“ = è¯­ä¹‰åˆ†æå¼•æ“(æ–‡æ³•)
        è¾“å…¥ä¸² = "int a"
        è¯­æ³•åˆ†æç»“æœ = [0, 1, 3]  # æ¨¡æ‹Ÿçš„äº§ç”Ÿå¼åºåˆ—
        
        æˆåŠŸ, åˆ†ææ­¥éª¤åˆ—è¡¨, é”™è¯¯ä¿¡æ¯ = åˆ†æå¼•æ“.æ‰§è¡Œè¯­ä¹‰åˆ†æ(è¾“å…¥ä¸², è¯­æ³•åˆ†æç»“æœ)
        
        print(f"   åˆ†ææ­¥éª¤æ•°: {len(åˆ†ææ­¥éª¤åˆ—è¡¨)}")
        print(f"   ç¬¦å·è¡¨é¡¹æ•°: {len(åˆ†æå¼•æ“.ç¬¦å·è¡¨.è¡¨é¡¹)}")
        
        if len(åˆ†ææ­¥éª¤åˆ—è¡¨) > 0:
            print("   âœ“ é›†æˆæµ‹è¯•æˆåŠŸ")
            return True
        else:
            print("   âœ— é›†æˆæµ‹è¯•å¤±è´¥")
            return False
        
    except Exception as e:
        print(f"   âœ— é›†æˆæµ‹è¯•å¤±è´¥: {e}")
        return False


def main():
    """ä¸»æµ‹è¯•å‡½æ•°"""
    print("Lå±æ€§æ–‡æ³•è¯­ä¹‰åˆ†æç¨‹åº - åŠŸèƒ½æµ‹è¯•")
    print("=" * 50)
    
    æµ‹è¯•ç»“æœ = []
    
    # è¿è¡Œå„é¡¹æµ‹è¯•
    æµ‹è¯•ç»“æœ.append(("åŸºæœ¬åŠŸèƒ½", test_basic_functionality()))
    æµ‹è¯•ç»“æœ.append(("æ–‡æ³•è§£æ", test_grammar_parsing()))
    æµ‹è¯•ç»“æœ.append(("ç¬¦å·è¡¨ç®¡ç†", test_symbol_table()))
    æµ‹è¯•ç»“æœ.append(("è¯­ä¹‰åˆ†æ", test_semantic_analysis()))
    æµ‹è¯•ç»“æœ.append(("é›†æˆåŠŸèƒ½", test_integration()))
    
    # è¾“å‡ºæµ‹è¯•ç»“æœ
    print("\n" + "=" * 50)
    print("æµ‹è¯•ç»“æœæ±‡æ€»:")
    
    æˆåŠŸæ•° = 0
    æ€»æ•° = len(æµ‹è¯•ç»“æœ)
    
    for æµ‹è¯•å, ç»“æœ in æµ‹è¯•ç»“æœ:
        çŠ¶æ€ = "âœ“ é€šè¿‡" if ç»“æœ else "âœ— å¤±è´¥"
        print(f"  {æµ‹è¯•å}: {çŠ¶æ€}")
        if ç»“æœ:
            æˆåŠŸæ•° += 1
    
    print(f"\næ€»ä½“ç»“æœ: {æˆåŠŸæ•°}/{æ€»æ•°} æµ‹è¯•é€šè¿‡")
    print(f"æˆåŠŸç‡: {(æˆåŠŸæ•°/æ€»æ•°*100):.1f}%")
    
    if æˆåŠŸæ•° == æ€»æ•°:
        print("\nğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç¨‹åºåŠŸèƒ½æ­£å¸¸ã€‚")
        return True
    else:
        print(f"\nâš ï¸  æœ‰ {æ€»æ•°-æˆåŠŸæ•°} ä¸ªæµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç›¸å…³åŠŸèƒ½ã€‚")
        return False


if __name__ == "__main__":
    try:
        æˆåŠŸ = main()
        sys.exit(0 if æˆåŠŸ else 1)
    except Exception as e:
        print(f"\næµ‹è¯•è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
